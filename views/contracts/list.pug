extends ../layout

block page_config
  - var activePage = 'deals'
  - var searchPlaceholder = 'Cari kontrak...'

block content
  .page-header
    h1.page-title Contract Workflow Pipeline
    p.page-subtitle Implementasi proses seperti diagram: Commercial/Sales -> Operational Lead -> Finance -> renewal.

  .grid.grid-cols-4(style='margin-bottom: 1rem;')
    .card
      .card-header
        h3.card-title Operational Lead
      .card-content
        .stats-value= laneCounts.ops || 0
        p.stats-change Tahap operasional
    .card
      .card-header
        h3.card-title Commercial / Sales
      .card-content
        .stats-value= laneCounts.commercial || 0
        p.stats-change Tahap sales & renewal
    .card
      .card-header
        h3.card-title Finance
      .card-content
        .stats-value= laneCounts.finance || 0
        p.stats-change Tahap approval & billing
    .card
      .card-header
        h3.card-title Super Admin
      .card-content
        .stats-value= laneCounts.super_admin || 0
        p.stats-change Monitoring seluruh proses

  .card(style='margin-bottom: 1rem;')
    .card-header
      h3.card-title Peta Alur Proses
    .card-content
      .workflow-lanes
        .workflow-lane
          h4.workflow-lane-title Operational Lead
          ul.workflow-list
            each stage in stages
              if stage.lane === 'ops'
                li= stage.label
        .workflow-lane
          h4.workflow-lane-title Commercial / Sales
          ul.workflow-list
            each stage in stages
              if stage.lane === 'commercial'
                li= stage.label
        .workflow-lane
          h4.workflow-lane-title Finance
          ul.workflow-list
            each stage in stages
              if stage.lane === 'finance'
                li= stage.label
        .workflow-lane
          h4.workflow-lane-title Super Admin
          ul.workflow-list
            li Login
            li Dashboard
            li Buat Akun
            li Monitoring Seluruh Proses

  .card
    .card-header
      h3.card-title Daftar Kontrak & Aksi Tahap
    .card-content
      .table-wrapper
        table.report-table
          thead
            tr
              th No
              th Client
              th Harga
              th Tahap Saat Ini
              th Role Tahap
              th Aksi
          tbody
            if data && data.length > 0
              each contract, index in data
                tr
                  td= index + 1
                  td= contract.client_name
                  td= 'Rp ' + Number(contract.price || 0).toLocaleString('id-ID')
                  td= contract.stageLabel
                  td
                    span.status-badge(
                      class=contract.stageLane === 'ops' ? 'status-warning' : contract.stageLane === 'finance' ? 'status-danger' : 'status-success'
                    )= contract.stageLane
                  td
                    if contract.allowedAction
                      form(method='post' action=`/contracts/${contract.id}/action/${contract.allowedAction.actionKey}`)
                        button(type='submit')= contract.allowedAction.label
                    else
                      span.stats-change Tidak ada aksi
            else
              tr
                td(colspan='6' style='text-align: center; padding: 2rem; color: #9ca3af;') Belum ada kontrak

  if user.role === 'commercial' || user.role === 'super_admin'
    .card(style='margin-top: 1rem;')
      .card-header
        h3.card-title Buat Kontrak Baru
      .card-content
        form(method='post' action='/contracts/create' style='max-width: 560px;')
          .form-group
            label(for='client_name') Nama Client
            input#client_name(name='client_name' type='text' placeholder='Masukkan nama client' required)
          .form-group
            label(for='price') Harga (Rp)
            input#price(name='price' type='number' min='0' placeholder='Masukkan harga' required)
          .grid.grid-cols-2
            .form-group
              label(for='start_date') Tanggal Mulai
              input#start_date(name='start_date' type='date')
            .form-group
              label(for='end_date') Tanggal Berakhir
              input#end_date(name='end_date' type='date')
          button(type='submit') Buat Kontrak
